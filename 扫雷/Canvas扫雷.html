<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŸºäºCanvasçš„æ‰«é›·æ¸¸æˆ</title>
    <style>
        #gnav {
            height: 40px;
            text-align: center;
        }

        #mine_total {
            width: 30px;
            text-align: center;
        }

        #timer {
            width: 60px;
            text-align: center;
        }
    </style>
</head>

<body>
    <div id="gnav">
        å‰©ä½™ï¼š<input type="text" id="mine_total" value='0'>
        <!-- onchangeäº‹ä»¶ç‚¹æ•´ä¸ªæ ‡ç­¾éƒ½å“åº” -->
        <input type="radio" name="level" id="lv-1" onchange="g_init(0)" checked='checked'>
        <label for="lv-1">åˆçº§</label>
        <input type="radio" name="level" id="lv-2" onchange="g_init(1)">
        <label for="lv-2">ä¸­çº§</label>
        <input type="radio" name="level" id="lv-3" onchange="g_init(2)">
        <label for="lv-3">é«˜çº§</label>
        <button id="btn" onclick="g_init()">é‡æ–°å¼€å§‹</button>
        <input type="text" id="timer" />
    </div>
    <canvas id="mycanv" height="800" width="800"></canvas>
    <script>
        var gnav = document.getElementById('gnav');
        var mine_total = document.getElementById('mine_total');
        var mine_timer = document.getElementById('timer');
        var canv = document.getElementById('mycanv');
        var ctx = canv.getContext('2d');


        // åˆå§‹åŒ–æ¸¸æˆä¿¡æ¯å˜é‡
        var levels = [
            [9, 9, 10],
            [16, 16, 40],
            [16, 30, 99]
        ];//è®¾å®šæ¸¸æˆéš¾åº¦9è¡Œ9åˆ—10ä¸ªé›·
        var level = levels[0];//åˆå§‹éš¾åº¦
        var g_arr = [];//å‚¨å­˜æ¯ä¸€ä¸ªå—åæ ‡ä½ç½® 0-0 2-3 x-y
        var g_obj = {}//ä»£è¡¨çš„æ¯ä¸€ä¸ªæ–¹å—çš„ä¿¡æ¯ï¼Œg[2-3]={mark:0,open:0}åæ ‡ä¸ºé”®ï¼Œmarkä»£è¡¨é™„è¿‘é›·çš„ä¸ªæ•°ï¼Œopenä»£è¡¨æ–¹å—çš„çŠ¶æ€
        var g_color = {
            block: '#369',
            open: '#ddd',
            mine: '#69d',
            bomb: '#a00',
            highlight: '#89f'
        }//é¢œè‰²æ•°ç»„
        var mine = ['ğŸ’£', 'ğŸš©', 'â”', 'ğŸ’¥'];//é¢„è®¾é›·å—æ ‡è®°ç¬¦å·
        var mine_arr = [];//é›·ä¿¡æ¯æ•°ç»„
        var count = 0;//æ ‡è®°é›·çš„ä¸ªæ•°
        var ttimer = 0;//æ—¶é—´
        var durtime = 0;//æ¸¸æˆè€—æ—¶è®°å½•


        //æ¸¸æˆå¼€å§‹
        g_init(0)
        function g_init(n) {
            level = n == undefined ? level : levels[n];//n=;ä»£è¡¨é‡æ–°å¼€å§‹ typeä¸ºundefined
            //é€‰æ‹©éš¾åº¦å é‡æ–°å®šä¹‰
            g_arr = []
            mine_arr = []
            count = 0
            //å¼€å¯ç›‘å¬äº‹ä»¶
            canv.addEventListener('click', openBlock)
            canv.addEventListener('contextmenu', markMine)
            mine_timer.value = 0;
            //æ¸…é™¤å®šæ—¶å™¨
            if (ttimer != 0) {
                clearInterval(ttimer);
                durtime = 0;
                ttimer = 0;
            }
            //é‡æ–°å®šä¹‰ç”»å¸ƒå¤§å°
            canv.width = level[1] * 50;
            canv.height = level[0] * 50;
            gnav.style.width = level[1] * 50 + 'px';//è®©æ˜¾ç¤ºæ å±…ä¸­
            mine_total.value = level[2];//ä¸åŒéš¾åº¦çš„é›·ä¸ªæ•°æ˜¾ç¤º
            ctx.clearRect(0, 0, level[1] * 50, level[0] * 50)//æ¸…ç©ºåŒºåŸŸ
            //ç»˜åˆ¶
            for (let i = 0; i < level[0]; i++) {
                for (let j = 0; j < level[1]; j++) {
                    let xy = j + '-' + i;
                    //æ¯ä¸€ä¸ªæ–¹å—çš„åæ ‡ä¿¡æ¯
                    g_arr.push(xy);
                    //æ¯ä¸€ä¸ªæ–¹å—ä¿¡æ¯åˆå§‹åŒ–
                    g_obj[xy] = { mark: 0, open: 0 }//mark=-1ä¸ºé›·0~8ä¸ºæ•°å­—å— open:0æœªæ‰“å¼€ï¼Œ1å·²æ‰“å¼€ï¼Œ-1æ ‡æ³¨é›·å—ï¼Œ2æ ‡æ³¨ç–‘ä¼¼é›·å—
                    drawBlock(xy, g_color.block)//ç»˜åˆ¶åœ†è§’çŸ©å½¢å‡½æ•°
                }
            }
            setMine();//éšæœºå¸ƒé›·
        }




        //è®¡æ—¶å™¨
        function startTimer() {//æ¸¸æˆå¼€å§‹è®¡æ—¶
            ttimer = setInterval(() => {
                durtime++;
                mine_timer.value = (durtime / 10).toFixed(1);
            }, 100);
        }






        //åˆå§‹åŒ–å¸ƒå±€ï¼šç»˜åˆ¶æ¸¸æˆå—


        //ç»˜åˆ¶åœ†è§’çŸ©å½¢
        function drawBlock(xy, c) {
            let w = 50, r = 6, m = 2;//width,radius,margin
            let [x, y] = xy.split('-').map(n => n * w)//map()è¿”å›ä¸€ä¸ªå¤„ç†è¿‡çš„æ•°ç»„
            ctx.save()//ä¿å­˜canvasåŸå…ˆçŠ¶æ€
            ctx.beginPath()//æ–°å»ºè·¯å¾„
            ctx.moveTo(x, y + r)//èµ·ç‚¹
            ctx.arcTo(x, y + w - m, x + w - m, y + w - m, r)//åˆ‡çº¿
            ctx.arcTo(x + w - m, y + w - m, x + w - m, y, r)
            ctx.arcTo(x + w - m, y, x, y, r)
            ctx.arcTo(x, y, x, y + w - m, r)
            ctx.fillStyle = c//å¡«å……é¢œè‰²
            ctx.fill()//å¡«å……å›¾å½¢
            ctx.restore()//æ¢å¤canvasåŸå…ˆçŠ¶æ€
        }





        //éšæœºå¸ƒé›·
        function setMine() {
            mine_arr = g_arr.sort(() => Math.random() - 0.5).slice(0, level[2])//éšæœº10ä¸ªå—ä½œä¸ºé›·
            mine_arr.forEach(n => {
                g_obj[n].mark = -1
                let around = getAround(n)//å‘¨è¾¹æ–¹å—
                around.forEach(xy => {
                    if (g_obj[xy].mark != -1) g_obj[xy].mark++
                })
            })
        }



        //è¾…åŠ©æ˜¾ç¤º
        // showInfo()//å¼€å¯æˆ–å…³é—­
        function showInfo() {
            g_arr.forEach(n => {
                if (g_obj[n].mark == -1) {
                    drawBlock(n, g_color.mine)//è®¾ç½®é›·å—å±æ€§
                } else {
                    markText(n, g_obj[n].mark)//è®¾ç½®å…¶ä»–å—æ•°å­—
                }
            })
        }
        //æ˜¾ç¤ºæ–‡æœ¬
        function markText(xy, txt) {
            let [x, y] = xy.split('-').map(n => n * 50);//åæ ‡
            ctx.save()
            ctx.font = '16px Arial'
            ctx.fillStyle = '#f63'
            ctx.textAlign = 'center'
            ctx.textBaseline = 'middle'
            ctx.fillText(txt, x + 25, y + 25)//å¡«å……æ–‡æœ¬
            ctx.restore()
        }



        //è·å–å‘¨è¾¹
        function getAround(xy) {
            let [x, y] = xy.split('-').map(n => n * 1)//xyæ‹†åˆ†è½¬æ¢ä¸ºæ•°å­—
            let around = []
            for (let i = -1; i <= 1; i++) {
                for (let j = -1; j <= 1; j++) {
                    let id = `${x + j}-${y + i}`//å­—ç¬¦æ‹¼æ¥
                    if (g_arr.includes(id) && id != xy) around.push(id)//æ£€æŸ¥æ˜¯å¦å­˜åœ¨
                }
            }
            return around
        }



        //é¼ æ ‡äº‹ä»¶ï¼šç®€å•å®ç°æ‰«é›·ï¼šclick  contextmenu
        // canv.addEventListener('click', openBlock)
        // canv.addEventListener('contextmenu', markMine)
        //é¼ æ ‡å·¦é”®æ‰“å¼€å—
        function openBlock(ev) {
            if (ttimer == 0) startTimer()
            let x = ~~(ev.offsetX / 50);//~~ç±»ä¼¼äºMathï¼Œfloor
            let y = ~~(ev.offsetY / 50);
            let xy = x + '-' + y;
            //æ‰“å¼€æ¸¸æˆå—ï¼šæ›´æ–°æ¸¸æˆæ•°æ®ï¼Œæ›´æ–°é¡µé¢
            g_obj[xy].open = 1;
            drawBlock(xy, g_color.open)//æ”¹å˜é¢œè‰²
            markText(xy, g_obj[xy].mark)//æ˜¾ç¤ºæ–‡æœ¬
            if (g_obj[xy].mark == 0) {
                //é€’å½’æ¸…é›¶
                openZero(xy)
            } else if (g_obj[xy].mark == -1) {
                //è§¦é›·ï¼Œæ¸¸æˆç»“æŸ
                drawBlock(xy, g_color.bomb)
                markText(xy, mine[0])
                markText(xy, mine[3])
                checkOver()
            }
            // console.log(x, y)
        }


        //é€’å½’æ¸…é›¶
        function openZero(xy) {
            let around = getAround(xy)
            around.forEach(n => {
                if (g_obj[n].open == 0) {
                    g_obj[n].open = 1
                    drawBlock(n, g_color.open)
                    markText(n, g_obj[n].mark)
                    if (g_obj[n].mark == 0) openZero(n)
                }
            })
        }


        //é¼ æ ‡å³é”®æ ‡è®°é›·å—
        function markMine(ev) {
            //ç›®æ ‡ï¼šæ ‡æ³¨é›·å—ï¼Œå¯¹æœªæ‰“å¼€çš„å—ï¼Œæ ‡æ³¨é›·å—-1ï¼Œæ ‡æ³¨ç–‘ä¼¼é›·å—2ï¼Œå–æ¶ˆæ ‡æ³¨0
            ev.preventDefault();//é˜»æ­¢é»˜è®¤èœå•
            let x = ~~(ev.offsetX / 50);//~~ç±»ä¼¼äºMathï¼Œfloor
            let y = ~~(ev.offsetY / 50);
            let xy = x + '-' + y;
            //æ›´æ–°æ•°æ® æ›´æ–°é¡µé¢
            if (g_obj[xy].open == 1) return;
            if (g_obj[xy].open == 0) {
                g_obj[xy].open = -1;
                drawBlock(xy, g_color.mine)
                markText(xy, mine[1])
                count++
                mine_total.value = level[2] - count;//æ˜¾ç¤ºå™¨ä¸Šæ ‡è¯†å‰©ä¸‹çš„é›·å—
                if (count == level[2]) checkOver()//æ ‡è®°è¾¾åˆ°é›·æ•°è¿›è¡Œåˆ¤æ–­
            } else if (g_obj[xy].open == -1) {
                g_obj[xy].open = 2;
                drawBlock(xy, g_color.mine)
                markText(xy, mine[2])
                count--
                mine_total.value = level[2] - count;
            } else if (g_obj[xy].open == 2) {
                g_obj[xy].open = 0;
                drawBlock(xy, g_color.block)
            }

        }

        //åˆ¤æ–­æ ‡è®°é›·è¾¾åˆ°æ•°ç›®åï¼Œæ˜¯å¦æ ‡è®°æ­£ç¡®
        function checkOver() {
            if (ttimer != 0) {
                clearInterval(ttimer);
                durtime = 0;
                ttimer = 0;
            }
            let win = mine_arr.every(n => g_obj[n].mark == g_obj[n].open)
            setTimeout(() => {
                alert(win ? 'æ­å–œèƒœåˆ©ï¼\nè€—æ—¶ï¼š' + mine_timer.value + 'ç§’' : 'æŒ‘æˆ˜å¤±è´¥')
                var ret = confirm('æ˜¯å¦ç»§ç»­æ¸¸æˆ')
                if (ret) {
                    //åˆ·æ–°é¡µé¢
                    // window.location.reload();
                    g_init();
                    mine_timer.value = 0;
                } else {
                    //å–æ¶ˆç›‘å¬äº‹ä»¶
                    canv.removeEventListener('click', openBlock)
                    canv.removeEventListener('contextmenu', markMine)
                    g_arr.forEach(n => {
                        g_obj[n].open = 1
                        drawBlock(n, g_color.open)
                        if (g_obj[n].mark == -1) {
                            markText(n, mine[0])
                        } else {
                            markText(n, g_obj[n].mark)
                        }
                    })
                }
            }, 100);
        }



        //è¾…åŠ©æ‰«é›·ï¼š mousedown , mouseup
        //1.æŒ‰ä¸‹é¼ æ ‡ï¼Œé«˜äº®å‘¨è¾¹ï¼Œæ¾å¼€é¼ æ ‡ï¼Œå–æ¶ˆé«˜äº®
        //2.è¾…åŠ©æ‰«é›·ï¼Œå¯¹äºæ˜ç¡®çš„é›·å—æˆ–å®‰å…¨å—è¿›è¡Œæ ‡æ³¨æˆ–æ‰“å¼€
        canv.addEventListener('mousedown', highLight)
        canv.addEventListener('mouseup', highLight)
        canv.addEventListener('mouseup', supGame)//å¯ä»¥è®¾ç½®å¤šä¸ªä¸€æ ·çš„ç›‘å¬äº‹ä»¶

        function highLight(ev) {
            let x = ~~(ev.offsetX / 50)
            let y = ~~(ev.offsetY / 50)
            let xy = x + '-' + y;
            if (g_obj[xy].open != 1) return
            let color = ev.type == 'mousedown' ? g_color.highlight : g_color.block;
            getAround(xy).forEach(n => {
                if (g_obj[n].open == 0) {
                    drawBlock(n, color)
                }
            })
        }
        // function unhighLight(ev) {
        //     let x = ~~(ev.offsetX / 50)
        //     let y = ~~(ev.offsetY / 50)
        //     let xy = x + '-' + y;
        //     if (g_obj[xy].open != 1) return
        //     getAround(xy).forEach(n => {
        //         if (g_obj[n].open == 0) {
        //             drawBlock(n, g_color.block)
        //         }
        //     })
        // }


        function supGame(ev) {
            let x = ~~(ev.offsetX / 50)
            let y = ~~(ev.offsetY / 50)
            let xy = x + '-' + y;
            if (g_obj[xy].open != 1) return
            let mark = g_obj[xy].mark;//è·å–è¿™ä¸ªå—é™„è¿‘é›·æ•°
            let marked_mine = 0;//æ ‡è®°é›·çš„ä¸ªæ•°
            let unopen = 0;//æ²¡æœ‰æ‰“å¼€å—çš„ä¸ªæ•°
            let around = getAround(xy);
            around.forEach(n => {
                if (g_obj[n].open == -1) marked_mine++
                if (g_obj[n].open == 0) unopen++
            })
            around.forEach(n => {
                if (g_obj[n].open == 0) {
                    if (mark == marked_mine) {//é™„è¿‘é›·çš„ä¸ªæ•°ä¸æ ‡è®°é›·çš„ä¸ªæ•°ä¸€æ ·æ—¶
                        g_obj[n].open = 1;
                        drawBlock(n, g_color.open)
                        markText(n, g_obj[n].mark)
                        if (g_obj[n].mark == -1) {//æ ‡è®°é”™è¯¯ï¼Œæ‰“å¼€äº†é›·ï¼Œæ¸¸æˆç»“æŸ
                            drawBlock(n, g_color.bomb)
                            markText(n, mine[0])
                            markText(n, mine[3])
                            checkOver()
                        }
                        if (g_obj[n].mark == 0) openZero(n)//æ‰“å¼€æ–¹å—æ˜¯0ç»§ç»­é€’å½’æ‰“å¼€å‘¨å›´æ–¹å—
                    } else if ((mark - marked_mine) == unopen) {//å¦‚æœå‘¨å›´æœªæ‰“å¼€æœªæ ‡è®°çš„æ–¹å—ä¸é™„è¿‘é›·å—æ•°ï¼ˆæŠ›å»æ ‡è®°é›·å—ï¼‰ä¸€æ ·æ—¶
                        g_obj[n].open = -1;
                        drawBlock(n, g_color.mine)
                        markText(n, mine[1])
                        count++;
                        mine_total.value = level[2] - count;
                        if (count == level[2]) checkOver()
                    }
                }
            })
        }
    </script>
</body>

</html>